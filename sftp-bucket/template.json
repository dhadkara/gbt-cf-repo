{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Transform": "AWS::Serverless-2016-10-31",
    "Description": "CF Template for Transform Individual Invoices",
    "Parameters": {
       "ServiceName": {
          "Description": "MicroServiceName",
          "Type": "String",
          "Default": "sftp-bucket"
       },
       "AWSEnvironment": {
          "Description": "AWS Environment Name",
          "Type": "String"
       }
    },
    "Resources": {
        "S3Bucket": {
           "Type": "AWS::S3::Bucket",
           "Properties": {
              "BucketName": {
                 "Fn::Join": [
                    "-",
                    [
                       {
                          "Ref": "ServiceName"
                       },
                       
                          "bronze",
                       {
                          "Ref": "AWSEnvironment"
                       }
                    ]
                 ]
              },
              "NotificationConfiguration":{
               "TopicConfigurations": [
                  {
                     "Event" : "s3:ObjectCreated:*",
                     "Topic" : {"Ref": "BronzeBucketTopic" }
                   }
               ]
            },
              "LifecycleConfiguration": {
                 "Rules": [
                    {
                       "Id": "DeleteContentAfter30Days",
                       "Status": "Enabled",
                       "ExpirationInDays": 30
                    }
                 ]
              }
           },
           "DeletionPolicy": "Delete"
        }
    },
    "BronzeBucketTopic" : {
      "Type" : "AWS::SNS::Topic",
      "Properties" : {
         "TopicName" : {"Fn::Join": [
            "-",
            [  
                  "invoice-bucket-trigger",
               {
                  "Ref": "AWSEnvironment"
               }
            ]
         ]}
      }
   },
   "BronzeTopicPolicy": {
      "Type": "AWS::SNS::TopicPolicy",
      "Properties": {
         "PolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
               {
                  "Sid": "AllowBucketToPushNotificationEffect",
                  "Effect": "Allow",
                  "Principal": {
                     "Service": "s3.amazonaws.com"
                  },
                  "Action": "sns:Publish",
                  "Resource": "*"
               }
            ]
         },
         "Topics": [
            {
               "Ref": "BronzeBucketTopic"
            }
         ]
      }
   },
    "Outputs": {
      "S3Bucket": {
         "Description": "Storage location for Invoice file to be processed by Lambda function",
         "Value" : { "Ref" : "S3Bucket"}
      },  
      "TopicBucketArn": {
           "Description": "SNS Topic for Invoice file to be processed by Lambda function Arn",
           "Value" : { "Fn::GetAtt" : [ "BronzeBucketTopic", "Arn" ]},
           "Export" : {
            "Name" : {
               "Fn::Join" : [ "-", [ { "Ref" : "AWS::StackName" }, "topic-arn" ] ]
             }
          }
        }
     }
    
}